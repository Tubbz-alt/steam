#!/usr/bin/make -f

export DH_VERBOSE=1

uversion=$(shell uscan --report | head -2 | tail -1 | cut -d\  -f7 | cut -d, -f1)
keepers=icons lib steam.6 steam.real steam.desktop steam_install_agreement.txt

files=$(shell find debian -name \*.i386 | sed s/\\.i386//g)

orig=../steam_$(uversion).orig.tar.xz
dest=../steam-$(uversion).orig

%:
	dh $@

override_dh_auto_configure:
	python debian/scripts/templates-helper
ifeq ($(DEB_BUILD_ARCH), i386)
	for file in $(files); do cp $$file.i386 $$file; done
endif

override_dh_clean:
	dh_clean -- debian/templates $(files)
	python debian/scripts/copyright-helper \
	    debian/copyright.in debian/copyright

get-orig-source:
	@test "$(uversion)" = "" && \
	    echo "There is no new upstream source file." && exit 1 || true 
	uscan --force-download --no-symlink
	rm -f $(orig)
	mkdir -p $(dest)
	tar xf ../steam_$(uversion).tar.gz --strip-components=1 -C $(dest)
	rm -f $(dest)/steam
	cd $(dest) && tar xf bootstrap*.tar.* --strip-components=1
	mv $(dest)/steam $(dest)/steam.real
	cd $(dest) && for file in *; do \
	    echo $(keepers) | grep -q $$file || rm -rf $$file; done
	tar cJf $(orig) $(dest)
	rm -rf $(dest)
	@echo "Successfully created new upstream source file: $(orig)"
